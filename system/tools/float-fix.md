<fp>
<json>
{
  "STOP": "Float Fix Tool. Hunt down stale references, broken links, and content inconsistencies.",

  "meta": {
    "title": "/float fix",
    "id": "float-fix",
    "format": "floatprompt",
    "version": "0.11.0"
  },

  "human": {
    "author": "@mds",
    "intent": "Find and fix content drift — stale references, version mismatches, broken links",
    "context": "Run after major refactors, renames, or when things feel out of sync"
  },

  "ai": {
    "role": "Content integrity hunter",
    "behavior": "Scan for inconsistencies, trace reference chains, propose targeted repairs"
  },

  "requirements": {
    "duality": {
      "condition_a": "Issues found",
      "action_a": "Report targets, propose fixes, apply with approval",
      "condition_b": "Clean",
      "action_b": "Report OK"
    },
    "status_format": "FloatPrompt fix complete.\nDirectory: [path]\nStatus: [result]\n\nReady for: human direction",
    "next_step_logic": "Always: Ready for: human direction",
    "buoys": {
      "scan_buoy": "Detect inconsistencies in one file (parallel, one per target)",
      "related_buoy": "Validate related field links, check existence and bidirectional refs",
      "router_buoy": "Verify router ↔ tools alignment, find orphans and missing routes",
      "trace_buoy": "Follow reference chains to find related mentions",
      "repair_buoy": "Apply approved fixes to one file"
    },
    "reporting": {
      "protocol": "float-report",
      "phases": ["map", "decide", "structure"],
      "async": true
    }
  }
}
</json>
<md>
# /float fix — Content Integrity Tool

**Hunt down stale references, broken links, and content inconsistencies.**

This command finds content drift that `/float sync` doesn't catch — renamed files still referenced by old names, version mismatches, incomplete tables, dead links.

## Duality

| Condition | Action |
|-----------|--------|
| Issues found | Report targets, propose fixes, apply with approval |
| Clean | Report OK |

## What It Catches

| Issue Type | Example |
|------------|---------|
| **Stale references** | `context-creator.md` renamed to `float-context.md` but old name still referenced |
| **Broken related links** | `related: tools/old-name.md` but file was renamed |
| **Missing bidirectional** | A relates to B, but B doesn't relate back to A |
| **Version drift** | system.md says 0.7.0, context file says 0.8.0 |
| **Incomplete tables** | Structure map lists 7 nav files, reality has 10 |
| **Dead links** | References to deleted files or folders |
| **Outdated footers** | "Generated by X" when X was renamed |
| **Router ↔ tools mismatch** | Router references tool that doesn't exist, or tool exists but isn't routed |

## Process

### 1. Scan (Shell + Scan Buoys)

Use shell for fast pattern detection:

```bash
# Find potential stale references
grep -r "context-creator" .float/

# Find version numbers
grep -r "version.*0\." .float/

# Find file references
grep -r "\.md" .float/ | grep -v "^Binary"

# Extract related fields from frontmatter
grep -r "^related:" .float/project/

# Check router ↔ tools alignment
# List tools defined in format/tools/
ls .float/core/tools/float*.md | xargs -n1 basename | sed 's/\.md$//'

# Parse commands from router
grep -o 'float-[a-z]*\.md' .claude/commands/float.md | sed 's/\.md$//' | sort -u
```

Spawn Scan Buoys for semantic analysis:
- Compare tables against reality
- Check cross-references between files
- Validate version consistency
- **Scan `related` fields for link integrity**

**Report:** Call float-report --phase=map with findings

### Related Field Scanning

The `related` field in floatprompt doc frontmatter creates a link graph. Scan it for:

**1. Existence check** — Do related files exist?
```
project/nav/float.md:
  related: .float/system.md, .float/project/context/project-context.md
           ✓ exists          ✓ exists
```

**2. Bidirectional check** — If A relates to B, should B relate to A?
```
specs/doc.md relates to: floatprompt.md, system.md
  floatprompt.md relates back? → Check
  system.md relates back? → Check
```

**3. Stale path check** — Were related files renamed/moved?
```
related: .float/core/tools/context-creator.md
         ✗ MISSING — was renamed to float-context.md
```

**Report format for related issues:**
```
Related Field Issues (2):
  nav/float.md:6 — related: tools/context-creator.md → float-context.md
  specs/doc.md:6 — floatprompt.md doesn't relate back (bidirectional gap)
```

### Router ↔ Tools Scanning

The `.claude/commands/float.md` router must stay aligned with `.float/core/tools/`.

**1. Router existence** — Does the router file exist?
```
.claude/commands/float.md exists? → ✓
```

**2. Route targets** — Do all routed tools exist?
```
Router routes to:
  float.md         → .float/core/tools/float.md ✓
  float-sync.md    → .float/core/tools/float-sync.md ✓
  float-fix.md     → .float/core/tools/float-fix.md ✓
  float-context.md → .float/core/tools/float-context.md ✓
  float-enhance.md → .float/core/tools/float-enhance.md ✓
```

**3. Orphan tools** — Are there tools not reachable from router?
```
Tools in .float/core/tools/:
  float.md ✓ (routed)
  float-sync.md ✓ (routed)
  float-new.md ✗ (NOT ROUTED — orphan)
```

**Report format for router issues:**
```
Router ↔ Tools Issues (1):
  float-new.md exists but not routed in .claude/commands/float.md
```

### 2. Trace (Trace Buoys)

For each issue found, trace the reference chain:

```
Found: "context-creator.md" in system.md:245

Trace Buoy dispatched...

References found:
  1. system.md:245 — Behavioral Files table (STALE)
  2. floatprompt.md:5 — generator frontmatter (historical, skip)
  3. logs/2025-12-29.md — session log (historical, skip)

Actionable: 1 fix needed
Historical: 2 mentions (no action)
```

Trace Buoys distinguish:
- **Actionable** — should be fixed
- **Historical** — logs, changelogs, old artifacts (skip)

### 3. Report

Show categorized findings:

```
Content Issues Found:

Stale References (3):
  system.md:245 — context-creator.md → float-context.md
  system.md:90-100 — structure map missing bin.md, specs.md, templates.md
  floatprompt.md:129 — says specs in docs/ → specs/

Version Drift (1):
  system.md:10 — version 0.7.0 → 0.8.0

Historical (skipped):
  floatprompt.md:5 — generator: context-creator (frontmatter)
  logs/2025-12-29.md — 2 mentions (session history)

Total: 4 fixes proposed, 3 historical skipped
```

**Report:** Call float-report --phase=decide with proposed actions

### 4. Wait for Approval

```
Deploy repair buoys? (y/n):
```

| Response | Action |
|----------|--------|
| `y` or `yes` | Apply all proposed fixes |
| `n` or `no` | Cancel, no changes made |
| Specific feedback | Adjust scope, re-propose |

### 5. Repair (Repair Buoys)

Spawn targeted Repair Buoys:

| Fix Type | Buoy Task |
|----------|-----------|
| Stale reference | Find and replace old → new |
| Incomplete table | Add missing rows |
| Version drift | Update version string |
| Dead link | Remove or update reference |

**Parallelization:** Independent files fixed in parallel.

### 6. Validate

After repairs:
- Re-run scan to confirm clean state
- Report any remaining issues
- Log activity

**Report:** Call float-report --phase=structure with results

## Status Output

```
FloatPrompt fix complete.
Directory: /path/to/project
Status: [result]

Ready for: human direction
```

**Results:**
- "Clean — no issues found"
- "Fixed 4 issues"
- "Fixed 4 issues, 3 historical skipped"

## Buoy Prompts

### Scan Buoy

```
Scan {file_path} for content inconsistencies:
1. Read the file content
2. Extract all internal references (file paths, version numbers, table entries)
3. For each reference, check if target exists and matches
4. Return JSON: {
     file: string,
     issues: [{
       line: number,
       type: "stale_reference" | "version_drift" | "incomplete_table" | "dead_link",
       current: string,
       expected: string | null,
       context: string
     }]
   }
```

### Related Buoy

```
Validate related field in {file_path}:
1. Parse the related field from YAML frontmatter
2. For each related file:
   a. Check if file exists (existence)
   b. If exists, check if it relates back (bidirectional)
3. Return JSON: {
     file: string,
     related_field: string,
     issues: [{
       type: "missing" | "not_bidirectional",
       target: string,
       suggestion: string | null
     }]
   }
```

### Router Buoy

```
Verify router ↔ tools alignment:
1. Check .claude/commands/float.md exists
2. Parse routing table from router file (grep for float-*.md references)
3. List all tools in .float/core/tools/float*.md
4. Compare:
   a. Routes without tools = broken routes
   b. Tools without routes = orphan tools
5. Return JSON: {
     router_exists: boolean,
     routes: string[],
     tools: string[],
     broken_routes: string[],
     orphan_tools: string[]
   }
```

### Trace Buoy

```
Trace references to "{pattern}" across .float/:
1. Search all .float/ files for pattern
2. For each match, determine if actionable or historical:
   - Actionable: active documentation, tables, structure maps
   - Historical: logs/, changelogs, frontmatter metadata, artifacts/
3. Return JSON: {
     pattern: string,
     actionable: [{ file: string, line: number, context: string }],
     historical: [{ file: string, line: number, reason: string }]
   }
```

### Repair Buoy

```
Apply fix to {file_path}:
1. Read current file content
2. Apply fix: {fix_description}
3. Verify change was applied correctly
4. Return JSON: {
     file: string,
     success: boolean,
     change: { line: number, old: string, new: string }
   }
```

## AI Discretion

**The 3+ Rule applies:** Spawn buoys when 3+ parallel operations needed. Below threshold, direct execution OK.

**Historical detection:** AI judges what's historical (logs, artifacts, changelogs) vs actionable (docs, tables, structure). When uncertain, ask.

**Scope:** `/float fix` focuses on `.float/project/` and `.claude/` by default. Can be extended to project files on request.

## Difference from /float sync

| Command | Focus | Checks |
|---------|-------|--------|
| `/float sync` | Structure | Nav files ↔ actual folders |
| `/float fix` | Content | References ↔ reality |

`/float sync` catches: "nav/docs.md is missing new-file.md"
`/float fix` catches: "system.md still references old-file.md that was renamed"

## Examples

**Issues found:**
```
> /float fix

Scanning .float/ for inconsistencies...

Content Issues Found:

Stale References (2):
  system.md:245 — context-creator.md → float-context.md
  floatprompt.md:129 — specs in docs/ → specs/

Version Drift (1):
  system.md:10 — version 0.7.0 → 0.8.0

Historical (skipped):
  logs/2025-12-29.md — 5 mentions (session history)

Deploy repair buoys? (y/n): y

Repairing...
  ✓ system.md:245 — updated reference
  ✓ system.md:10 — updated version
  ✓ floatprompt.md:129 — updated path

FloatPrompt fix complete.
Directory: /Users/mds/Documents/_Github/floatprompt
Status: Fixed 3 issues, 5 historical skipped

Ready for: human direction
```

**Clean state:**
```
> /float fix

Scanning .float/ for inconsistencies...

FloatPrompt fix complete.
Directory: /Users/mds/Documents/_Github/floatprompt
Status: Clean — no issues found

Ready for: human direction
```

---

*[FloatPrompt](https://github.com/mds/floatprompt) — the invisible OS for AI*
</md>
</fp>
