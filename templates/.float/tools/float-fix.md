<fp>
<json>
{
  "STOP": "Float Fix Tool. Hunt down stale references, broken links, and content inconsistencies.",

  "meta": {
    "title": "/float fix",
    "id": "float-fix",
    "format": "floatprompt",
    "version": "0.17.0"
  },

  "human": {
    "author": "@mds",
    "intent": "Find content drift — stale references, version mismatches, broken links",
    "context": "Run after major refactors, renames, or when things feel out of sync"
  },

  "ai": {
    "role": "Content integrity hunter",
    "behavior": "Scan for inconsistencies, trace reference chains, report findings to logs. NEVER modify files outside .float/"
  },

  "requirements": {
    "containment": ".float/ tools only write inside .float/. This tool reports findings but human applies fixes to project files.",
    "duality": {
      "condition_a": "Issues found",
      "action_a": "Report targets and suggested fixes to logs/",
      "condition_b": "Clean",
      "action_b": "Report OK"
    },
    "status_format": "FloatPrompt fix scan complete.\nDirectory: [path]\nIssues: [count]\nReport: logs/{date}/float-fix-run-{n}/\n\nReady for: human to review and apply fixes",
    "next_step_logic": "Human reviews report, applies fixes manually. After applying: run /float-think to continue.",
    "buoys": {
      "scan_buoy": "Detect inconsistencies in one file (parallel, one per target)",
      "related_buoy": "Validate related field links, check existence and bidirectional refs",
      "router_buoy": "Verify router ↔ tools alignment, find orphans and missing routes",
      "trace_buoy": "Follow reference chains to find related mentions"
    },
    "reporting": {
      "protocol": "float-report",
      "phases": ["map", "decide", "structure"],
      "async": true
    }
  }
}
</json>
<md>
# /float fix — Content Integrity Tool

**Hunt down stale references, broken links, and content inconsistencies.**

This command finds content drift that `/float sync` doesn't catch — renamed files still referenced by old names, version mismatches, incomplete tables, dead links.

## Duality

| Condition | Action |
|-----------|--------|
| Issues found | Report targets and suggested fixes to `logs/` |
| Clean | Report OK |

## Containment Principle

This tool observes but never modifies files outside `.float/`. All findings are written to `logs/{date}/float-fix-run-{n}/`. Human reviews the report and applies fixes manually.

**Why:** Delete `.float/` = zero trace. AI observes, human modifies.

## What It Catches

| Issue Type | Example |
|------------|---------|
| **Stale references** | `context-creator.md` renamed to `float-context.md` but old name still referenced |
| **Broken related links** | `related: tools/old-name.md` but file was renamed |
| **Missing bidirectional** | A relates to B, but B doesn't relate back to A |
| **Version drift** | system.md says 0.7.0, context file says 0.8.0 |
| **Incomplete tables** | Structure map lists 7 nav files, reality has 10 |
| **Dead links** | References to deleted files or folders |
| **Outdated footers** | "Generated by X" when X was renamed |
| **Router ↔ tools mismatch** | Router references tool that doesn't exist, or tool exists but isn't routed |

## Process

### 1. Scan (Shell + Scan Buoys)

Use shell for fast pattern detection:

```bash
# Find potential stale references
grep -r "context-creator" .float/

# Find version numbers
grep -r "version.*0\." .float/

# Find file references
grep -r "\.md" .float/ | grep -v "^Binary"

# Extract related fields from frontmatter
grep -r "^related:" .float/project/

# Check router ↔ tools alignment
# List tools in .float/tools/
ls .float/tools/float*.md | xargs -n1 basename | sed 's/\.md$//'

# Parse commands from router
grep -o 'float-[a-z]*\.md' .claude/commands/float.md | sed 's/\.md$//' | sort -u
```

Spawn Scan Buoys for semantic analysis:
- Compare tables against reality
- Check cross-references between files
- Validate version consistency
- **Scan `related` fields for link integrity**

**Report:** Call float-report --phase=map with findings

### Related Field Scanning

The `related` field in floatprompt doc frontmatter creates a link graph. Scan it for:

**1. Existence check** — Do related files exist?
```
project/nav/float.md:
  related: .float/system.md, .float/project/context/project-context.md
           ✓ exists          ✓ exists
```

**2. Bidirectional check** — If A relates to B, should B relate to A?
```
specs/doc.md relates to: floatprompt.md, system.md
  floatprompt.md relates back? → Check
  system.md relates back? → Check
```

**3. Stale path check** — Were related files renamed/moved?
```
related: .float/tools/context-creator.md
         ✗ MISSING — was renamed to float-context.md
```

**Report format for related issues:**
```
Related Field Issues (2):
  nav/float.md:6 — related: tools/context-creator.md → float-context.md
  specs/doc.md:6 — floatprompt.md doesn't relate back (bidirectional gap)
```

### Router ↔ Tools Scanning

The `.claude/commands/float.md` router must stay aligned with `.float/tools/`.

**1. Router existence** — Does the router file exist?
```
.claude/commands/float.md exists? → ✓
```

**2. Route targets** — Do all routed tools exist?
```
Router routes to:
  float.md         → .float/tools/float.md ✓
  float-sync.md    → .float/tools/float-sync.md ✓
  float-fix.md     → .float/tools/float-fix.md ✓
  float-context.md → .float/tools/float-context.md ✓
  float-enhance.md → .float/tools/float-enhance.md ✓
```

**3. Orphan tools** — Are there tools not reachable from router?
```
Tools in .float/tools/:
  float.md ✓ (routed)
  float-sync.md ✓ (routed)
  float-new.md ✗ (NOT ROUTED — orphan)
```

**Report format for router issues:**
```
Router ↔ Tools Issues (1):
  float-new.md exists but not routed in .claude/commands/float.md
```

### 2. Trace (Trace Buoys)

For each issue found, trace the reference chain:

```
Found: "context-creator.md" in system.md:245

Trace Buoy dispatched...

References found:
  1. system.md:245 — Behavioral Files table (STALE)
  2. floatprompt.md:5 — generator frontmatter (historical, skip)
  3. logs/2025-12-29.md — session log (historical, skip)

Actionable: 1 fix needed
Historical: 2 mentions (no action)
```

Trace Buoys distinguish:
- **Actionable** — should be fixed
- **Historical** — logs, changelogs, old artifacts (skip)

### 3. Report

Show categorized findings:

```
Content Issues Found:

Stale References (3):
  system.md:245 — context-creator.md → float-context.md
  system.md:90-100 — structure map missing bin.md, specs.md, templates.md
  floatprompt.md:129 — says specs in docs/ → specs/

Version Drift (1):
  system.md:10 — version 0.7.0 → 0.8.0

Historical (skipped):
  floatprompt.md:5 — generator: context-creator (frontmatter)
  logs/2025-12-29.md — 2 mentions (session history)

Total: 4 fixes proposed, 3 historical skipped
```

**Report:** Call float-report --phase=decide with proposed actions

### 4. Write Report

Write all findings to `logs/{date}/float-fix-run-{n}/`:
- `map.md` — What was scanned, what was found
- `decide.md` — Proposed fixes with exact locations and replacements
- `structure.md` — Summary for human review

**Report:** Call float-report --phase=structure with summary

### 5. Human Applies Fixes

The report in `logs/` contains:
- Exact file paths and line numbers
- Current (broken) values
- Suggested replacements

Human reviews and applies fixes using their preferred method (editor, sed, etc.).

## Status Output

```
FloatPrompt fix scan complete.
Directory: /path/to/project
Issues: [count]
Report: logs/{date}/float-fix-run-{n}/

Ready for: human to review and apply fixes
```

**Results:**
- "Issues: 0 — clean"
- "Issues: 4 (3 actionable, 1 historical)"

## Buoy Prompts

### Scan Buoy

```
Scan {file_path} for content inconsistencies:
1. Read the file content
2. Extract all internal references (file paths, version numbers, table entries)
3. For each reference, check if target exists and matches
4. Return JSON: {
     file: string,
     issues: [{
       line: number,
       type: "stale_reference" | "version_drift" | "incomplete_table" | "dead_link",
       current: string,
       expected: string | null,
       context: string
     }]
   }
```

### Related Buoy

```
Validate related field in {file_path}:
1. Parse the related field from YAML frontmatter
2. For each related file:
   a. Check if file exists (existence)
   b. If exists, check if it relates back (bidirectional)
3. Return JSON: {
     file: string,
     related_field: string,
     issues: [{
       type: "missing" | "not_bidirectional",
       target: string,
       suggestion: string | null
     }]
   }
```

### Router Buoy

```
Verify router ↔ tools alignment:
1. Check .claude/commands/float.md exists
2. Parse routing table from router file (grep for float-*.md references)
3. List all tools in .float/tools/float*.md
4. Compare:
   a. Routes without tools = broken routes
   b. Tools without routes = orphan tools
5. Return JSON: {
     router_exists: boolean,
     routes: string[],
     tools: string[],
     broken_routes: string[],
     orphan_tools: string[]
   }
```

### Trace Buoy

```
Trace references to "{pattern}" across .float/:
1. Search all .float/ files for pattern
2. For each match, determine if actionable or historical:
   - Actionable: active documentation, tables, structure maps
   - Historical: logs/, changelogs, frontmatter metadata, artifacts/
3. Return JSON: {
     pattern: string,
     actionable: [{ file: string, line: number, context: string }],
     historical: [{ file: string, line: number, reason: string }]
   }
```

## AI Discretion

**The 3+ Rule applies:** Spawn buoys when 3+ parallel operations needed. Below threshold, direct execution OK.

**Historical detection:** AI judges what's historical (logs, artifacts, changelogs) vs actionable (docs, tables, structure). When uncertain, ask.

**Scope:** `/float fix` scans the entire project but only writes reports to `.float/project/logs/`. Human applies fixes to any files outside `.float/`.

## Difference from /float sync

| Command | Focus | Checks |
|---------|-------|--------|
| `/float sync` | Structure | Nav files ↔ actual folders |
| `/float fix` | Content | References ↔ reality |

`/float sync` catches: "nav/docs.md is missing new-file.md"
`/float fix` catches: "system.md still references old-file.md that was renamed"

## Examples

**Issues found:**
```
> /float fix

Scanning project for inconsistencies...

Content Issues Found:

Stale References (2):
  system.md:245 — context-creator.md → float-context.md
  README.md:45 — old-path/ → new-path/

Version Drift (1):
  system.md:10 — version 0.7.0 → 0.8.0

Historical (skipped):
  logs/2025-12-29.md — 5 mentions (session history)

Writing report...

FloatPrompt fix scan complete.
Directory: /Users/mds/Documents/_Github/floatprompt
Issues: 3 (3 actionable, 5 historical)
Report: logs/2025-12-30/float-fix-run-1/

Ready for: human to review and apply fixes
```

**Human then reviews `logs/2025-12-30/float-fix-run-1/decide.md`:**
```markdown
# Decide: float-fix

## Proposed Fixes

1. system.md:245
   - Current: `context-creator.md`
   - Replace: `float-context.md`

2. README.md:45
   - Current: `old-path/`
   - Replace: `new-path/`

3. system.md:10
   - Current: `version: 0.7.0`
   - Replace: `version: 0.8.0`
```

**Clean state:**
```
> /float fix

Scanning project for inconsistencies...

FloatPrompt fix scan complete.
Directory: /Users/mds/Documents/_Github/floatprompt
Issues: 0 — clean

Ready for: human direction
```

---

*[FloatPrompt](https://github.com/mds/floatprompt) — the invisible OS for AI*
</md>
</fp>
