<fp>
<json>
{
  "STOP": "Buildable Spec: float build command. Review and lock before implementation.",

  "meta": {
    "id": "float-build-spec",
    "title": "float build — Static Context Generation",
    "status": "draft",
    "created": "2026-01-04",
    "session": 21
  },

  "human": {
    "author": "@mds",
    "intent": "Define the MVP for static context file generation"
  },

  "decisions": {
    "path_encoding": "double-dash (src--auth.md)",
    "context_location": ".float/context/",
    "default_tier": "standard",
    "cross_refs": "deferred (AI inference later)",
    "mvp_scope": "single tier (standard), no watch mode, no parallel buoys"
  }
}
</json>
<md>
# float build — Static Context Generation

**Status:** Draft — Needs lock before build
**Created:** 2026-01-04 (Session 21)
**Source:** `float-CMS-context-management-system.md`

---

## The Goal

One command. Pre-built context files. Zero runtime queries.

```bash
float build
```

Result:
```
.float/context/
├── _root.standard.md
├── src.standard.md
├── src--db.standard.md
├── src--buoys.standard.md
├── src--cli.standard.md
└── ...
```

AI session reads ONE file instead of querying SQLite.

---

## Locked Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Path encoding** | Double-dash (`--`) | Readable, reversible, filesystem-safe |
| **Context location** | `.float/context/` | Single location, easy gitignore |
| **Default tier** | `standard` (<2000 tokens) | Balance of context vs token cost |
| **Cross-refs** | Deferred | AI inference is future work |
| **MVP scope** | Single tier, no watch, no parallel | Get it working first |

---

## MVP Scope

### In Scope (Build This)

1. **`float build`** — Generate `.standard.md` for all folders
2. **`float build <path>`** — Generate for specific path + ancestors
3. **`float build --stale`** — Only rebuild folders where content changed
4. **Context file format** — Scope chain + current folder + recent logs
5. **Staleness tracking** — Hash-based detection

### Out of Scope (Later)

- Multiple tiers (minimal/full/deep)
- Watch mode (`float watch`)
- Parallel buoy building
- Cross-scope references
- Snapshot boot (Layer 3)

---

## Context File Format

Each file is self-contained. AI reads it and has full context for that location.

```markdown
# Context: /src/db

> Generated: 2026-01-04T14:32:00Z
> Tier: standard
> Source hash: a1b2c3d4

---

## Project

[Root scope_boot or description — compressed]

FloatPrompt: Omnipresent recursive context scaffolding for AI.
SQLite stores folder metadata, relationships, logs. Buoys generate context.

---

## Scope Chain

### / (root)
FloatPrompt system. TypeScript, SQLite, buoys.

### /src
TypeScript source. DB layer, CLI, buoys.

---

## Current: /src/db

### Description
Database layer. SQLite schema, queries, CRUD operations for folders,
files, log entries, and context management.

### Context
[Full content_md — patterns, conventions, insights]

The database serves AI, not humans. Key tables:
- folders: 65 rows, hierarchical with scope detection
- files: 447 rows, content hashes for change detection
- log_entries: decision history with folder association

Queries use better-sqlite3 (synchronous). Schema in schema.ts,
connection in client.ts.

### Files
- schema.ts — Zod schemas + SQL DDL
- client.ts — Database connection, CRUD
- scan.ts — Filesystem scanner (Layer 1)
- generate.ts — Context generation (Layer 2)
- import.ts — Markdown parser

### Recent Decisions
- 2026-01-03: Chose SQLite over Postgres (speed, portability)
- 2026-01-03: 16-field schema locked

---

## Navigation

**Parent:** /src
**Siblings:** /src/cli, /src/buoys
**Children:** none

---

*Generated by float build. Source: .float/float.db*
```

---

## Architecture

```
float.db (source of truth)
    │
    │ float build
    ▼
.float/context/*.standard.md (static files)
    │
    │ AI session
    ▼
Read one file → full context
```

### Build Flow

```
1. Get all folders from float.db
2. For each folder:
   a. Get scope chain (ancestors with is_scope=true)
   b. Get folder details (description, content_md)
   c. Get recent log entries (last 5)
   d. Assemble markdown
   e. Compute source hash
   f. Write to .float/context/{encoded-path}.standard.md
   g. Store hash in folders.context_hash
```

### Staleness Detection

```
On float build --stale:
1. For each folder:
   a. Compute current source hash
   b. Compare to stored context_hash
   c. If different → rebuild
   d. If same → skip
```

Source hash = `sha256(content_md + ancestor_hashes + log_hashes)`

---

## Database Changes

Add to `folders` table:

```sql
ALTER TABLE folders ADD COLUMN context_hash TEXT;
ALTER TABLE folders ADD COLUMN context_built_at INTEGER;
```

---

## CLI Interface

```bash
# Build all folders
float build

# Build specific path (and ancestors)
float build /src/db

# Build only stale folders
float build --stale

# Preview what would be built (dry run)
float build --dry-run

# Force rebuild (ignore staleness)
float build --force
```

### Output

```
$ float build --stale

Building context files...
  /src/db — rebuilt (content changed)
  /src/cli — skipped (current)
  /src/buoys — rebuilt (new log entry)
  /src — rebuilt (child changed)
  / — rebuilt (child changed)

Built: 4 files
Skipped: 61 files
Output: .float/context/
```

---

## Implementation

### New Files

```
src/build/
├── context.ts    # Core build logic
├── format.ts     # Markdown formatting
├── hash.ts       # Source hash computation
└── index.ts      # Public exports
```

### Core Functions

```typescript
// context.ts

interface BuildOptions {
  path?: string;      // specific path, or all
  stale?: boolean;    // only rebuild stale
  force?: boolean;    // ignore staleness
  dryRun?: boolean;   // preview only
}

interface BuildResult {
  built: string[];
  skipped: string[];
  errors: string[];
}

async function build(db: Database, options: BuildOptions): Promise<BuildResult>;
async function buildFolder(db: Database, folder: Folder): Promise<string>;
async function assembleScopeChain(db: Database, path: string): Promise<Folder[]>;
async function getRecentLogs(db: Database, path: string, limit: number): Promise<LogEntry[]>;
function computeSourceHash(folder: Folder, ancestors: Folder[], logs: LogEntry[]): string;
function encodePath(path: string): string;  // '/src/db' → 'src--db'
function formatContext(data: ContextData): string;  // → markdown
```

### CLI Addition

```typescript
// float-db.ts

program
  .command('build [path]')
  .description('Generate static context files')
  .option('--stale', 'Only rebuild stale folders')
  .option('--force', 'Force rebuild all')
  .option('--dry-run', 'Preview without writing')
  .action(async (path, options) => {
    const result = await build(db, { path, ...options });
    console.log(`Built: ${result.built.length} files`);
    console.log(`Skipped: ${result.skipped.length} files`);
  });
```

---

## Token Budget

**Target:** <2000 tokens for standard tier

| Section | Budget |
|---------|--------|
| Header/metadata | 50 |
| Project (root summary) | 150 |
| Scope chain (summarized ancestors) | 300 |
| Current folder (full) | 1000 |
| Recent logs (5 entries) | 300 |
| Navigation | 100 |
| **Total** | ~1900 |

If over budget:
1. Truncate content_md (keep first N chars)
2. Reduce log count
3. Compress ancestor descriptions

---

## Verification

After build:

```bash
# Count generated files
ls .float/context/*.md | wc -l
# Should match folder count

# Check token count (rough)
wc -w .float/context/src--db.standard.md
# Should be <1500 words (~2000 tokens)

# Verify hash stored
sqlite3 .float/float.db "SELECT path, context_hash FROM folders WHERE context_hash IS NOT NULL LIMIT 5"
```

---

## Open Questions

None. MVP scope is locked.

---

## Dependencies

- `src/db/client.ts` — Database connection (exists)
- `src/db/schema.ts` — Folder/LogEntry types (exists)
- `folders` table with `content_md` populated (partial — needs Layer 2 run)

---

## Success Criteria

1. `float build` generates `.float/context/*.standard.md` for all 65 folders
2. Each file is <2000 tokens
3. Each file contains scope chain + current context + recent logs
4. `float build --stale` correctly detects and skips unchanged folders
5. AI can read a context file and understand the folder without SQLite queries

---

## Next Steps (After Build)

1. Integrate with boot.md — teach AI to read context files
2. Add minimal/full/deep tiers
3. Add watch mode
4. Add parallel building (buoys)
5. Add snapshot tier (Layer 3)

---

*Draft spec for float build — Session 21, 2026-01-04*
</md>
</fp>
