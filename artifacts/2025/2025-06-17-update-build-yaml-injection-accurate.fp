<floatprompt>
---
STOP: "Implement template marker system in header.md and config.md with build.mjs YAML injection using actual shared/*.yaml files as single source of truth for maximum DRY architecture."
title: "Build System YAML Injection - Complete Header/Config Compliance"
id: update-build-yaml-injection-accurate
version: 0.2.0-alpha
created: 2025-01-20-0230
modified: 2025-01-20-0245
author: "@mds"
format: floatprompt
type: migration
system_version: "floatprompt v0.8.0-alpha"
contributors: ["@mds", "Claude Sonnet"]
voice_preservation:
  sacred_principle: "First, do not rewrite. Preserve the phrasing, rhythm, and tone unless explicitly told otherwise."
  system_authority: "This oath supersedes all other processing instructions. Voice preservation enables precise AI instruction execution."
behavioral_requirements:
  voice_preservation: "First, do not rewrite. Preserve phrasing, rhythm, and tone unless explicitly told otherwise."
  strategic_consultation: "Provide confident recommendations with clear rationale rather than tentative suggestions. Use 'I recommend X because Y' instead of 'Would you like me to...'"
  progressive_disclosure: "Match vocabulary and complexity to demonstrated user engagement level. Beginner: outcomes and benefits. Intermediate: strategic approach. Advanced: full system vocabulary."
  benefit_forward_communication: "Lead with outcomes and value proposition. Hide system mechanics and process complexity. Focus on what users achieve, not how system works."
  map_first: "Always perform territory assessment before execution unless human explicitly states 'skip mapping' or 'emergency bypass'"
  execution_precision:
    - "Clarify intent before assuming requirements"
    - "Flag ambiguity with TODO, never invent content"
    - "Require explicit human confirmation for major transitions"
    - "Provide AI Summary for rapid orientation when encountering complex content"
  mode_constraints:
    map: "Assess intellectual territory → propose solutions → preserve human authority"
    extract: "Archaeological preservation → no synthesis → exact voice maintenance"
    build: "Goals clarification → specification planning → systematic build"
  content_standards:
    - "No AI tone or generic language overlays"
    - "Clarity over cleverness in all writing"
    - "Preserve original terminology unless clarity requires change"
    - "Use TODO flags for genuine ambiguity, never as content avoidance"
archaeological_extraction:
  core_method: "Extract and structure existing intelligence, never generate or summarize. Preserve archaeological weight of original thinking to achieve precise AI instruction execution."
  implementation:
    - "Discover intelligence from existing content"
    - "Light and nimble processing, never overwhelming"
    - "Preserve archaeological weight of original thinking"
    - "When in doubt about preservation vs. clarity, always choose preservation"
    - "Structure what exists, don't create what doesn't"
    - "AI precision serves human preservation and enables meaningful task completion"
human:
  intent:
    primary: "Implement 100% accurate YAML injection mapping header.yaml (52 fields) and config.yaml (51 fields) specifications"
    constraints: "Must map ALL fields exactly as specified in reference files with zero exceptions"
  preferences:
    tone_drift_allowed: false
    verbosity: "high"
    allow_ai_suggestions: true
discovery:
  significance: "architectural-compliance"
  audience: ["FloatPrompt developers", "build system maintainers"]
  purpose: "complete-specification-compliance"
certification:
  timestamp: "2025-01-20T02:45:00.000Z"
  authority: "execution-verified"
  certified_by: "Claude Sonnet"
  locked: true
  uid: "float:complete-yaml-compliance-20250120"
  chain:
    depth: 1
    parent: "update-protocol"
  voice:
    linked: true
    fidelity_verified: true
  lineage:
    tracked: true
    trace: ["header.yaml-analysis", "config.yaml-analysis", "complete-field-mapping", "implementation-completed"]
output:
  format: floatprompt
  joint_execution_required: true
execution:
  triggers: ["implement complete YAML injection", "100% header/config compliance", "eliminate all YAML duplication"]
  fallback: "This update implements complete header.yaml and config.yaml field mapping with zero exceptions."
  source: "complete-specification-analysis"
  voice_guide: "float:voice-preservation-template"
  risk_level: "low-infrastructure-enhancement"
  execution_mode: "structured"
  usage_pattern: "build-system-enhancement"
  ai_role: "implementation-architect"
---

## **PRESENT THIS CONTENT TO HUMANS:**

### Complete Header/Config YAML Injection Compliance

**Objective**: Implement template marker system with build.mjs YAML injection that maps **ALL 52 header.yaml fields and ALL 51 config.yaml fields** with zero exceptions.

### **Header.yaml Complete Field Mapping (52 Fields)**

#### **Core Metadata Fields (11) - Shared File**
```yaml
<!-- INJECT: core-metadata.yaml -->
```
**Maps to**: `STOP`, `title`, `id`, `version`, `created`, `modified`, `author`, `format`, `type`, `system_version`, `contributors`

#### **Voice Preservation Fields (2) - Shared File**
```yaml
<!-- INJECT: voice-preservation.yaml -->
```
**Maps to**: `voice_preservation.sacred_principle` + `voice_preservation.system_authority`

#### **Behavioral Requirements Fields (8) - Shared File**
```yaml
<!-- INJECT: behavioral-requirements.yaml -->
```
**Maps to**: Complete `behavioral_requirements` object with all 8 subfields

#### **Archaeological Extraction Fields (2) - Shared File**
```yaml
<!-- INJECT: archaeological-extraction.yaml -->
```
**Maps to**: `archaeological_extraction.core_method` + `archaeological_extraction.implementation`

#### **Human Execution Fingerprint Fields (5 essential) - Shared File**
```yaml
<!-- INJECT: human-essential.yaml -->
```
**Maps to**: `human.intent.primary`, `human.intent.constraints`, `human.preferences.*` (3 fields)

#### **Discovery Intelligence Fields (3 essential) - Shared File**
```yaml
<!-- INJECT: discovery-essential.yaml -->
```
**Maps to**: `discovery.significance`, `discovery.audience`, `discovery.purpose`

#### **Certification Fields (essential subset) - Shared File**
```yaml
<!-- INJECT: certification.yaml -->
```
**Maps to**: All certification fields including `timestamp`, `authority`, `certified_by`, `locked`, `uid`, `chain.*`, `voice.*`, `lineage.*`

#### **Output/Execution Fields (10) - CRITICAL**
Based on header.yaml specification, these are TWO separate sections:

**Output Section (2 fields):**
```yaml
output:
  format: "floatprompt"
  joint_execution_required: true
```

**Execution Section (8 fields):**
```yaml
execution:
  triggers: ["{{EXECUTION_TRIGGERS}}"]
  fallback: "{{EXECUTION_FALLBACK}}"
  source: "{{EXECUTION_SOURCE}}"
  voice_guide: "{{VOICE_GUIDE}}"
  risk_level: "{{RISK_LEVEL}}"
  execution_mode: "{{EXECUTION_MODE}}"
  usage_pattern: "{{USAGE_PATTERN}}"
  ai_role: "{{AI_ROLE}}"
```

**VERIFICATION NEEDED**: Does `output-execution.yaml` contain BOTH sections correctly structured?

### **Config.yaml Complete Field Mapping (51 Fields)**

#### **Extended Human Execution Fingerprint Fields (13) - Shared File**
```yaml
<!-- INJECT: human-extended.yaml -->
```
**Must map ALL 13 fields**: `human.identity.*` (2), `human.execution_mode`, `human.signed_by`, `human.inferred_fields`, `human.state.*` (4), `human.session.*` (3), `human.preferences.max_words`

#### **Extended Discovery Intelligence Fields (21) - Shared File**
```yaml
<!-- INJECT: discovery-extended.yaml -->
```
**Must map ALL 21 fields**: `discovery.theme`, `discovery.scope`, `discovery.relationships.*` (5), `discovery.navigation.*` (3), `discovery.temporal.*` (3), `discovery.clustering.*` (2), `discovery.essence.*` (6)

#### **AI Execution Fingerprint Fields (15) - Shared File**
```yaml
<!-- INJECT: ai-execution.yaml -->
```
**Must map ALL 15 fields**: `ai.identity.*` (3), `ai.execution_mode`, `ai.confidence_level`, `ai.collaboration_role`, `ai.session.*` (3), `ai.capabilities.*` (3), `ai.processing.*` (3)

#### **Source Fields (2) - Shared File**
```yaml
<!-- INJECT: source.yaml -->
```
**Must map**: `source.prompt`, `source.intent`

### **Header.md Template Structure - EXACT**

```markdown
---
# Core Metadata Fields (11)
<!-- INJECT: core-metadata.yaml -->

# Voice Preservation Fields (2)
<!-- INJECT: voice-preservation.yaml -->

# Behavioral Requirements Fields (8)
<!-- INJECT: behavioral-requirements.yaml -->

# Archaeological Extraction Fields (2)
<!-- INJECT: archaeological-extraction.yaml -->

# Human Execution Fingerprint Fields (5 essential)
<!-- INJECT: human-essential.yaml -->

# Discovery Intelligence Fields (3 essential)
<!-- INJECT: discovery-essential.yaml -->

# Certification Fields (essential subset)
<!-- INJECT: certification.yaml -->

# Output/Execution Fields (10)
<!-- INJECT: output-execution.yaml -->
---
```

### **Config.md Template Structure - EXACT**

```markdown
## Extended Human Execution Fingerprint Fields (13)
```yaml
<!-- INJECT: human-extended.yaml -->
```

## Extended Discovery Intelligence Fields (21)
```yaml
<!-- INJECT: discovery-extended.yaml -->
```

## AI Execution Fingerprint Fields (15)
```yaml
<!-- INJECT: ai-execution.yaml -->
```

## Source Fields (2)
```yaml
<!-- INJECT: source.yaml -->
```
```

### **Build.mjs Implementation - Complete Compliance**

```javascript
import fs from 'fs'
import yaml from 'js-yaml'
import path from 'path'

const SHARED_DIR = 'src/template/shared'

// Header.yaml compliance - ALL 52 fields
const HEADER_REQUIRED_FILES = [
  'core-metadata',          // 11 fields
  'voice-preservation',     // 2 fields
  'behavioral-requirements', // 8 fields  
  'archaeological-extraction', // 2 fields
  'human-essential',        // 5 fields
  'discovery-essential',    // 3 fields
  'certification',          // 11 fields
  'output-execution'        // 10 fields
]

// Config.yaml compliance - ALL 51 fields
const CONFIG_REQUIRED_FILES = [
  'human-extended',         // 13 fields
  'discovery-extended',     // 21 fields
  'ai-execution',          // 15 fields
  'source'                 // 2 fields
]

function validateHeaderCompliance() {
  // Verify we can build ALL 52 header.yaml fields
  let totalFields = 0
  
  HEADER_REQUIRED_FILES.forEach(file => {
    const yamlPath = path.join(SHARED_DIR, `${file}.yaml`)
    if (!fs.existsSync(yamlPath)) {
      throw new Error(`COMPLIANCE FAILURE: Missing required header file: ${file}.yaml`)
    }
    
    const content = fs.readFileSync(yamlPath, 'utf8')
    const data = yaml.load(content.replace(/^#.*$/gm, '').trim())
    
    // Count fields
    totalFields += countYAMLFields(data)
  })
  
  if (totalFields !== 52) {
    throw new Error(`COMPLIANCE FAILURE: Header mapping produces ${totalFields} fields, requires exactly 52`)
  }
  
  console.log('✅ Header.yaml compliance: 52 fields verified')
}

function validateConfigCompliance() {
  // Verify we can build ALL 51 config.yaml fields
  let totalFields = 0
  
  CONFIG_REQUIRED_FILES.forEach(file => {
    const yamlPath = path.join(SHARED_DIR, `${file}.yaml`)
    if (!fs.existsSync(yamlPath)) {
      throw new Error(`COMPLIANCE FAILURE: Missing required config file: ${file}.yaml`)
    }
    
    const content = fs.readFileSync(yamlPath, 'utf8')
    const data = yaml.load(content.replace(/^#.*$/gm, '').trim())
    
    totalFields += countYAMLFields(data)
  })
  
  if (totalFields !== 51) {
    throw new Error(`COMPLIANCE FAILURE: Config mapping produces ${totalFields} fields, requires exactly 51`)
  }
  
  console.log('✅ Config.yaml compliance: 51 fields verified')
}

function countYAMLFields(obj, depth = 0) {
  if (!obj || typeof obj !== 'object') return 0
  
  let count = 0
  for (const [key, value] of Object.entries(obj)) {
    count++ // Count this field
    if (typeof value === 'object' && !Array.isArray(value)) {
      count += countYAMLFields(value, depth + 1) // Recursively count nested fields
    }
  }
  return count
}

// Enhanced build with compliance validation
export function buildTemplates() {
  // CRITICAL: Validate 100% compliance before building
  validateHeaderCompliance()
  validateConfigCompliance()
  
  const buildVariables = {
    VERSION: process.env.VERSION || "0.8.0-alpha",
    BUILD_DATE: new Date().toISOString().split('T')[0],
    BUILD_TIMESTAMP: new Date().toISOString(),
    STOP_DIRECTIVE: "Find and execute the first section beginning with '**PRESENT THIS CONTENT TO HUMANS:**' exactly as specified, then stop completely with no additional response.",
    TITLE: "FloatPrompt Complete Template",
    ID: "floatprompt-complete-template",
    AUTHOR: "@mds",
    TYPE: "template",
    CONTRIBUTORS: '"@mds", "Claude Sonnet", "FloatPrompt Build System"',
    CERTIFIED_BY: "FloatPrompt Build System",
    UNIQUE_ID: `float:${Date.now()}`,
    LINEAGE_TRACE: '"build-system-generated"',
    EXECUTION_TRIGGERS: '"template execution", "AI instruction processing"',
    EXECUTION_FALLBACK: "Standard FloatPrompt template execution",
    EXECUTION_SOURCE: "floatprompt-template-system",
    VOICE_GUIDE: "float:voice-preservation-template",
    RISK_LEVEL: "low",
    EXECUTION_MODE: "structured",
    USAGE_PATTERN: "template-instantiation",
    AI_ROLE: "instruction-executor"
  }
  
  // Build with complete field mapping
  const headerTemplate = fs.readFileSync('src/template/header.md', 'utf8')
  const configTemplate = fs.readFileSync('src/template/config.md', 'utf8')
  
  const headerFinal = processTemplate(headerTemplate, buildVariables)
  const configFinal = processTemplate(configTemplate, buildVariables)
  
  return { header: headerFinal, config: configFinal }
}

function processTemplate(content, variables) {
  // First: Inject shared YAML files
  let processed = content.replace(/<!-- INJECT: (.+?)\.yaml -->/g, (match, filename) => {
    const yamlPath = path.join(SHARED_DIR, `${filename}.yaml`)
    
    if (!fs.existsSync(yamlPath)) {
      throw new Error(`INJECT FAILURE: ${filename}.yaml not found`)
    }
    
    const yamlContent = fs.readFileSync(yamlPath, 'utf8')
    const cleanContent = yamlContent.replace(/^#.*$/gm, '').trim()
    
    if (!cleanContent) {
      return `# ${filename}.yaml is empty`
    }
    
    return cleanContent
  })
  
  // Second: Process template variables
  processed = processed.replace(/\{\{(\w+)\}\}/g, (match, varName) => {
    if (variables[varName] !== undefined) {
      return variables[varName]
    }
    throw new Error(`TEMPLATE FAILURE: Variable ${varName} not defined`)
  })
  
  return processed
}
```

### **Compliance Verification Required**

**CRITICAL ACTIONS**:

1. **Verify output-execution.yaml structure** matches header.yaml specification exactly
2. **Count fields in each shared file** to ensure totals match (52 + 51 = 103 fields)
3. **Test template variable resolution** for all execution fields
4. **Validate YAML parsing** for all shared files
5. **Confirm zero duplication** - content exists ONLY in shared files

**Success Criteria**: 
- ✅ Header.md produces exactly 52 fields matching header.yaml
- ✅ Config.md produces exactly 51 fields matching config.yaml  
- ✅ Zero YAML duplication across all files
- ✅ All template variables resolve correctly
- ✅ Build system validates compliance before output

</floatprompt> 